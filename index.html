<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>房产地图分页展示</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <style>
    body { margin: 0; padding: 0; }
    #map { height: 400px; width: 100%; }
    .project-list { padding: 20px; }
    .pagination { justify-content: center; }
    .floating-buttons {
      position: fixed;
      right: 20px;
      bottom: 20px;
      z-index: 999;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
  </style>
</head>
<body>

  <!-- 地图区域 -->
  <div id="map"></div>

  <!-- 房产项目列表 -->
  <div class="container project-list">
    <h2 class="mb-4">精选房地产项目</h2>
    <div class="row row-cols-1 row-cols-md-3 g-4" id="project-container"></div>
    <nav>
      <ul class="pagination mt-4">
        <li class="page-item"><a class="page-link" href="#" id="prevPage">上一页</a></li>
        <li class="page-item"><a class="page-link" href="#" id="nextPage">下一页</a></li>
      </ul>
    </nav>
  </div>

  <!-- 浮动按钮 -->
  <div class="floating-buttons">
    <a href="https://wa.me/60169583621" target="_blank" class="btn btn-success">📞 WhatsApp 联系我</a>
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#calculatorModal">🧮 房贷计算器</button>
  </div>

  <!-- 房贷计算器 Modal -->
  <div class="modal fade" id="calculatorModal" tabindex="-1" aria-labelledby="calculatorModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content p-3">
        <div class="modal-header">
          <h5 class="modal-title" id="calculatorModalLabel">房贷计算器</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="关闭"></button>
        </div>
        <div class="modal-body">
          <form id="loanForm">
            <div class="mb-3">
              <label for="price" class="form-label">房价 (RM)</label>
              <input type="number" class="form-control" id="price" required>
            </div>
            <div class="mb-3">
              <label for="downpayment" class="form-label">头期款 (RM)</label>
              <input type="number" class="form-control" id="downpayment" required>
            </div>
            <div class="mb-3">
              <label for="years" class="form-label">贷款年限</label>
              <input type="number" class="form-control" id="years" required>
            </div>
            <div class="mb-3">
              <label for="rate" class="form-label">年利率 (%)</label>
              <input type="number" class="form-control" id="rate" step="0.01" required>
            </div>
            <div class="mb-3">
              <button type="submit" class="btn btn-primary">计算</button>
            </div>
          </form>
          <div id="result" class="alert alert-info d-none"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Leaflet + Bootstrap JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    const projects = [
      { id: 'project-a', title: '项目 A', desc: '吉隆坡市中心，3房2厅', img: 'https://via.placeholder.com/300x200', lat: 3.139, lng: 101.6869, page: 1 },
      { id: 'project-b', title: '项目 B', desc: '八打灵再也高层住宅', img: 'https://via.placeholder.com/300x200', lat: 3.105, lng: 101.640, page: 1 },
      { id: 'project-c', title: '项目 C', desc: '梳邦再也永久地契', img: 'https://via.placeholder.com/300x200', lat: 3.073, lng: 101.518, page: 1 },
      { id: 'project-d', title: '项目 D', desc: '双威城近捷运', img: 'https://via.placeholder.com/300x200', lat: 3.072, lng: 101.607, page: 2 },
      { id: 'project-e', title: '项目 E', desc: '沙登新区住宅', img: 'https://via.placeholder.com/300x200', lat: 3.020, lng: 101.700, page: 2 },
      { id: 'project-f', title: '项目 F', desc: '赛城绿意洋房', img: 'https://via.placeholder.com/300x200', lat: 2.950, lng: 101.661, page: 2 },
      { id: 'project-g', title: '项目 G', desc: '蒲种实惠公寓', img: 'https://via.placeholder.com/300x200', lat: 3.045, lng: 101.629, page: 3 },
      { id: 'project-h', title: '项目 H', desc: '吉隆坡南区全新项目', img: 'https://via.placeholder.com/300x200', lat: 3.080, lng: 101.680, page: 3 },
    ];

    let currentPage = 1;
    const pageSize = 6;

    let map;
    let markers = [];

    function renderProjects() {
      const container = document.getElementById('project-container');
      container.innerHTML = '';
      const start = (currentPage - 1) * pageSize;
      const end = start + pageSize;
      const pageProjects = projects.slice(start, end);
      pageProjects.forEach(p => {
        const col = document.createElement('div');
        col.className = 'col';
        col.id = p.id;
        col.innerHTML = `
          <div class="card">
            <img src="${p.img}" class="card-img-top" alt="${p.title}">
            <div class="card-body">
              <h5 class="card-title">${p.title}</h5>
              <p class="card-text">${p.desc}</p>
              <a href="#" class="btn btn-primary">查看详情</a>
            </div>
          </div>
        `;
        container.appendChild(col);
      });
    }

    function renderMap() {
      // 初始化地图，如果地图已经存在则不重新创建
      if (!map) {
        map = L.map('map').setView([3.139, 101.6869], 11);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '© OpenStreetMap contributors'
        }).addTo(map);
      }

      // 清除已有的 markers
      markers.forEach(marker => map.removeLayer(marker));
      markers = [];

      // 在地图上添加 marker
      projects.forEach(p => {
        const marker = L.marker([p.lat, p.lng]).addTo(map)
          .bindPopup(`${p.title}（点击跳转）`)
          .on('click', () => {
            // 判断 Marker 属于哪一页
            if (currentPage !== p.page) {
              currentPage = p.page;
              renderProjects();  // 重新渲染页面
              renderMap();       // 重新渲染地图
            }
            const target = document.getElementById(p.id);
            if (target) {
              target.scrollIntoView({ behavior: 'smooth' });
            } else {
              alert('项目当前不在本页，请切换分页查看。');
            }
          });

        markers.push(marker);
      });
    }

    document.getElementById('prevPage').addEventListener('click', e => {
      e.preventDefault();
      if (currentPage > 1) {
        currentPage--;
        renderProjects();
        renderMap();
      }
    });

    document.getElementById('nextPage').addEventListener('click', e => {
      e.preventDefault();
      if (currentPage < Math.ceil(projects.length / pageSize)) {
        currentPage++;
        renderProjects();
        renderMap();
      }
    });

    renderProjects();
    renderMap();

    // 房贷计算器逻辑
    document.getElementById('loanForm').addEventListener('submit', function(e) {
      e.preventDefault();
      const price = parseFloat(document.getElementById('price').value);
      const down = parseFloat(document.getElementById('downpayment').value);
      const years = parseInt(document.getElementById('years').value);
      const rate = parseFloat(document.getElementById('rate').value) / 100;

      const loanAmount = price - down;
      const monthlyRate = rate / 12;
      const months = years * 12;
      const monthlyPayment = loanAmount * monthlyRate / (1 - Math.pow(1 + monthlyRate, -months));

      const resultDiv = document.getElementById('result');
      resultDiv.classList.remove('d-none');
      resultDiv.textContent = `每月供款大约：RM ${monthlyPayment.toFixed(2)}`;
    });
  </script>
</body>
</html>
