<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>My Dream House</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
    }
    #map { height: 400px; width: 100%; }
    .filter { display: flex; justify-content: center; gap: 10px; margin: 10px; }
    .filter select { padding: 8px; border-radius: 6px; }
    .projects { display: flex; flex-wrap: wrap; gap: 10px; padding: 10px; }
    .project { flex: 0 0 calc(33.333% - 20px); background: #f9f9f9; border: 1px solid #ddd; border-radius: 8px; padding: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); cursor: pointer; }
    .pagination { text-align: center; margin: 20px 0; }
    .pagination button { padding: 5px 10px; margin: 0 2px; }
    .whatsapp-float { position: fixed; bottom: 20px; right: 20px; background-color: #25d366; color: white; border-radius: 50%; width: 60px; height: 60px; font-size: 28px; text-align: center; line-height: 60px; box-shadow: 0 2px 10px rgba(0,0,0,0.3); z-index: 999; text-decoration: none; }
    .calculator-float { position: fixed; bottom: 100px; right: 20px; background-color: #007bff; color: white; border: none; border-radius: 50%; width: 60px; height: 60px; font-size: 28px; text-align: center; line-height: 60px; box-shadow: 0 2px 10px rgba(0,0,0,0.3); cursor: pointer; z-index: 999; }
    .calculator-popup { display: none; position: fixed; bottom: 180px; right: 20px; width: 280px; background: white; border: 1px solid #ccc; border-radius: 10px; padding: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.2); z-index: 999; }
    .calculator-popup input { width: 100%; padding: 6px; margin: 5px 0; }
    .calculator-popup button { width: 100%; padding: 8px; margin-top: 10px; background-color: #28a745; color: white; border: none; border-radius: 6px; }
    .result { text-align: center; margin-top: 10px; }
    .lang-switch { position: fixed; top: 10px; right: 20px; }
  </style>
</head>
<body>
  <div class="lang-switch">
    <select id="langSelect" onchange="switchLang()">
      <option value="en">English</option>
      <option value="zh">ä¸­æ–‡</option>
    </select>
  </div>
  <div id="map"></div>
  <div class="filter">
    <select id="areaFilter" onchange="applyFilter()"><option value="all">å…¨éƒ¨åœ°åŒº</option></select>
  </div>
  <div class="projects" id="projectList"></div>
  <div class="pagination" id="pagination"></div>

  <a href="https://wa.me/60169583621?text=æˆ‘å¯¹æ‚¨çš„æˆ¿äº§é¡¹ç›®æ„Ÿå…´è¶£" target="_blank" class="whatsapp-float">ğŸ’¬</a>
  <button class="calculator-float" onclick="toggleCalculator()">ğŸ§®</button>
  <div class="calculator-popup" id="calculatorBox">
    <h3 id="calcTitle">æˆ¿è´·è®¡ç®—å™¨</h3>
    <label id="labelPrice">æˆ¿ä»· (RM):</label><input type="number" id="price" />
    <label id="labelRate">å¹´åˆ©ç‡ (%):</label><input type="number" id="rate" step="0.01" />
    <label id="labelYears">è´·æ¬¾å¹´é™:</label><input type="number" id="years" />
    <button onclick="calculateLoan()" id="calcButton">è®¡ç®—</button>
    <div id="loanResult" class="result"></div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    let projects = [];
    async function loadProjects() {
      const res = await fetch('https://mydreamhouse-backend.onrender.com/api/projects');
      projects = await res.json();
      populateFilters(); renderProjects(); renderMap();
    }
    function populateFilters() {
      const areas = [...new Set(projects.map(p=>p.area))];
      const areaFilter = document.getElementById('areaFilter');
      areas.forEach(a=>{ let o=new Option(a,a); areaFilter.add(o); });
    }
    let map;
    function renderMap() {
      if (!map) map = L.map('map').setView([3.05,101.7],10);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{ attribution:'Â© OSM' }).addTo(map);
      projects.forEach(p=>{ L.marker([p.lat,p.lng]).addTo(map).on('click',()=>{ window.location.href=p.link; }); });
    }
    let currentPage=1; const perPage=6;
    function renderProjects(page=1) {
      currentPage=page; const filter=areaFilter.value;
      let list=projects.filter(p=>filter==='all'||p.area===filter);
      const start=(page-1)*perPage, end=start+perPage;
      const container=document.getElementById('projectList'); container.innerHTML='';
      list.slice(start,end).forEach(p=>{ let d=document.createElement('div'); d.className='project'; d.innerHTML=`<h4 data-i18n="${p.name}">${p.name}</h4><p>åœ°åŒº: ${p.area}</p>`; d.onclick=()=>window.location.href=p.link; container.appendChild(d); });
      const pag=document.getElementById('pagination'); pag.innerHTML='';
      for(let i=1;i<=Math.ceil(list.length/perPage);i++){let b=document.createElement('button');b.textContent=i; b.onclick=()=>renderProjects(i); if(i===page){b.style.fontWeight='bold';} pag.appendChild(b);}    }
    function applyFilter(){ renderProjects(1); }
    function toggleCalculator(){ let c=document.getElementById('calculatorBox'); c.style.display=c.style.display==='block'?'none':'block'; }
    function calculateLoan(){ const price=parseFloat(price.value), rate=parseFloat(rate.value)/100/12, years=parseInt(years.value), n=years*12;
      const m=(price*rate*Math.pow(1+rate,n))/(Math.pow(1+rate,n)-1);
      loanResult.textContent=isFinite(m)?`æ¯æœˆè¿˜æ¬¾: RM ${m.toFixed(2)}`:'è¯·è¾“å…¥æœ‰æ•ˆæ•°å€¼'; }
    function switchLang(){ const lang=langSelect.value;
      document.documentElement.lang=lang;
      document.getElementById('calcTitle').textContent=lang==='zh'?'æˆ¿è´·è®¡ç®—å™¨':'Loan Calculator';
      document.getElementById('labelPrice').textContent=lang==='zh'?'æˆ¿ä»· (RM):':'Price (RM):';
      document.getElementById('labelRate').textContent=lang==='zh'?'å¹´åˆ©ç‡ (%):':'Annual Rate (%):';
      document.getElementById('labelYears').textContent=lang==='zh'?'è´·æ¬¾å¹´é™:':'Years:';
      document.getElementById('calcButton').textContent=lang==='zh'?'è®¡ç®—':'Calculate';
    }
    loadProjects();
  </script>
</body>
</html>
